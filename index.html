<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>  
        :root {
            --day-bg-color: #f0e68c;
            --night-bg-color: #121212;
            --day-text-color: #333;
            --night-text-color: #f0f0f0;
            --day-card-bg: rgba(255, 255, 255, 0.3);
            --night-card-bg: rgba(30, 30, 30, 0.5);
            --input-background: rgba(255, 255, 255, 0.8);
            --input-border: 1px solid #ccc;
            --input-text: #333;
            --button-primary: #4CAF50;
            --button-danger: #d32f2f;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: var(--day-bg-color);
            color: var(--day-text-color);
            transition: background-color 1s, color 1s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }
        
        body.dark-mode {
            background-color: var(--night-bg-color);
            color: var(--night-text-color);
        }
        
        .top-row {
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        
        .time-date {
            font-size: 3rem;
        }
        
        .time-display {
            font-size: 5rem;
            font-weight: bold;
        }
        
        .date-display {
            font-size: 1.8rem;
        }
        
        .weather-now {
            text-align: right;
            font-size: 4rem;
        }
        
        .feels-like {
            font-size: 1.8rem;
        }
        
        .current-day {
            display: flex;
            margin: 15px;
        }
        
        .big-day {
            font-size: 5rem;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .today-label {
            font-size: 1.8rem;
        }
        
        .today-weather {
            margin-left: 20px;
            display: flex;
            align-items: center;
            font-size: 1.8rem;
        }
        
        .middle-section {
            display: flex;
            flex: 1;
            padding: 0 20px;
        }
        
        .today-events {
            flex: 1;
            margin-right: 20px;
        }
        
        .event {
            margin: 15px 0;
            font-size: 1.4rem;
        }
        
        .event-time {
            display: inline-block;
            width: 120px;
        }
        
        .forecast-days {
            display: flex;
            flex: 3;
        }
        
        .day-forecast {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            margin: 0 5px;
            border-left: 3px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .day-forecast {
            border-left: 3px solid rgba(255, 255, 255, 0.1);
        }
        
        .day-header {
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .day-date {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .day-name {
            font-size: 1.5rem;
        }
        
        .day-temp {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }
        
        .day-events {
            margin-top: 15px;
        }
        
        .day-event {
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        .shopping-list {
            flex: 1;
            max-width: 20%;
            padding: 15px;
            background-color: var(--day-card-bg);
            border-radius: 10px;
            margin-left: 10px;
            transition: background-color 1s;
        }
        
        body.dark-mode .shopping-list {
            background-color: var(--night-card-bg);
        }
        
        .shopping-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .shopping-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 1.2rem;
        }
        

        .shopping-new-item {
            display: flex;
            margin-top: 10px;
        }

        .shopping-new-item input {
            flex: 1;
            padding: 5px;
            margin-right: 5px;
        }
        .hourly-forecast {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            margin-top: auto;
        }
        
        .hour-forecast {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .hour-label {
            font-size: 1.2rem;
        }
        
        .hour-icon {
            font-size: 2rem;
            margin: 10px 0;
        }
        
        .hour-precipitation {
            font-size: 0.9rem;
            color: #4682B4;
        }
        
        body.dark-mode .hour-precipitation {
            color: #87CEFA;
        }
        
        .hour-temp {
            font-size: 1.2rem;
        }
        
        .settings-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        .settings-icon:hover {
            opacity: 1;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            transition: right 0.3s;
            overflow-y: auto;
            z-index: 1000;
        }
        
        body.dark-mode .settings-panel {
            background-color: rgba(30, 30, 30, 0.95);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-size: 1.8rem;
        }
        
        .close-settings {
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        
        .settings-option {
            margin: 10px 0;
        }
        
        .settings-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .settings-input, .settings-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background-color: var(--input-background);
            border: var(--input-border);
            color: var(--input-text);
            border-radius: 4px;
        }

        body.dark-mode .settings-input, 
        body.dark-mode .settings-select {
            background-color: rgba(60, 60, 60, 0.8);
            color: white;
            border-color: #555;
        }
        
        .settings-checkbox {
            margin-right: 10px;
        }
        
        .settings-button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        .settings-button.danger {
            background-color: var(--button-danger);
        }

        /* Improved calendar form layout */
        .calendar-item {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        body.dark-mode .calendar-item {
            background-color: rgba(60, 60, 60, 0.5);
            border-color: #555;
        }
        
        .calendar-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .calendar-form-field {
            margin-bottom: 10px;
        }
        
        .calendar-form-field.full-width {
            grid-column: 1 / span 2;
        }
        
        .calendar-form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .calendar-form-field input[type="text"],
        .calendar-form-field input[type="url"] {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: var(--input-background);
            color: var(--input-text);
        }

        body.dark-mode .calendar-form-field input[type="text"],
        body.dark-mode .calendar-form-field input[type="url"] {
            background-color: rgba(60, 60, 60, 0.8);
            color: white;
            border-color: #555;
        }
        
        .calendar-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .color-picker {
            width: 40px;
            height: 30px;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        
        .calendar-list {
            margin: 10px 0;
        }
        
        .calendar-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .calendar-enabled {
            display: flex;
            align-items: center;
        }
        
        .calendar-enabled label {
            margin-right: 5px;
        }
        
        .widget-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        
        /* Event color coding */
        .cal-0 { border-left: 4px solid #4285F4; padding-left: 8px; }
        .cal-1 { border-left: 4px solid #EA4335; padding-left: 8px; }
        .cal-2 { border-left: 4px solid #FBBC05; padding-left: 8px; }
        .cal-3 { border-left: 4px solid #34A853; padding-left: 8px; }
        .cal-4 { border-left: 4px solid #8E24AA; padding-left: 8px; }
        .cal-5 { border-left: 4px solid #039BE5; padding-left: 8px; }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hide settings panel toggle on TVs/kiosk mode */
        .kiosk-mode .settings-icon {
            display: none;
        }

        /* Responsive font sizes for large screens */
        @media screen and (min-width: 1920px) {
            .time-display {
                font-size: 7rem;
            }
            
            .date-display {
                font-size: 2.5rem;
            }
            
            .big-day {
                font-size: 7rem;
            }
            
            .today-label {
                font-size: 2.5rem;
            }
            
            .today-weather {
                font-size: 2.5rem;
            }
            
            .event {
                font-size: 2rem;
            }
            
            .day-date {
                font-size: 3.5rem;
            }
            
            .day-name {
                font-size: 2rem;
            }
            
            .day-temp {
                font-size: 2.5rem;
            }
            
            .day-event {
                font-size: 1.8rem;
            }
            
            .shopping-title {
                font-size: 2.5rem;
            }
            
            .shopping-item {
                font-size: 1.8rem;
            }
            
            .hour-label {
                font-size: 1.8rem;
            }
            
            .hour-icon {
                font-size: 3rem;
            }
            
            .hour-precipitation {
                font-size: 1.5rem;
            }
            
            .hour-temp {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="settings-icon">
        <i class="fas fa-cog"></i>
    </div>

    <div class="settings-panel">
        <div class="settings-header">
            <div class="settings-title">Dashboard Settings</div>
            <div class="close-settings"><i class="fas fa-times"></i></div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Location</div>
            <div class="settings-option">
                <label class="settings-label">Use browser location:</label>
                <input type="checkbox" id="use-browser-location" class="settings-checkbox" checked>
            </div>
            <div class="settings-option" id="manual-location-input" style="display: none;">
                <label class="settings-label">City:</label>
                <input type="text" id="location-city" class="settings-input" placeholder="Arlington" value="Arlington">
                <label class="settings-label">State/Region:</label>
                <input type="text" id="location-state" class="settings-input" placeholder="VA" value="VA">
                <label class="settings-label">Zip/Postal Code:</label>
                <input type="text" id="location-zip" class="settings-input" placeholder="22201" value="22201">
                <label class="settings-label">Country:</label>
                <input type="text" id="location-country" class="settings-input" placeholder="USA" value="USA">
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Weather</div>
            <div class="settings-option">
                <label class="settings-label">Weather API Key (OpenWeatherMap):</label>
                <input type="text" id="weather-api-key" class="settings-input" placeholder="Enter your API key">
                <a href="https://home.openweathermap.org/users/sign_up" target="_blank">Get a free API key</a>
            </div>
            <div class="settings-option">
                <label class="settings-label">Units:</label>
                <select id="weather-units" class="settings-select">
                    <option value="imperial">Fahrenheit (US)</option>
                    <option value="metric">Celsius (Metric)</option>
                </select>
            </div>
            <div class="settings-option">
                <label class="settings-label">Refresh interval (minutes):</label>
                <input type="number" id="weather-refresh" class="settings-input" min="5" max="60" value="15">
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Calendar</div>
            <div class="settings-option">
                <button id="add-calendar" class="settings-button">Add Calendar</button>
            </div>
            <div id="calendars-container" class="calendar-list">
                <!-- Calendars will be added here dynamically -->
            </div>
            <div class="settings-option">
                <label class="settings-label">Refresh interval (minutes):</label>
                <input type="number" id="calendar-refresh" class="settings-input" min="1" max="60" value="5">
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Shopping List</div>
            <div class="settings-option">
                <label class="settings-label">Service:</label>
                <select id="shopping-service" class="settings-select">
                    <option value="google">Google Tasks</option>
                    <option value="todoist">Todoist</option>
                </select>
            </div>
            
            <div id="todoist-settings" style="display: none;">
                <div class="settings-option">
                    <label class="settings-label">Todoist API Token:</label>
                    <input type="text" id="todoist-api-token" class="settings-input" placeholder="Enter your API token">
                    <a href="https://todoist.com/app/settings/integrations" target="_blank">Get your API token</a>
                </div>
                <div class="settings-option">
                    <label class="settings-label">Project name for shopping list:</label>
                    <input type="text" id="todoist-project" class="settings-input" placeholder="Shopping" value="Shopping">
                </div>
            </div>
            
            <div id="google-tasks-settings">
                <div class="settings-option">
                    <label class="settings-label">Task List Name:</label>
                    <input type="text" id="gtasks-list" class="settings-input" placeholder="Shopping" value="Shopping">
                </div>
                <div class="settings-option">
                    <button id="authorize-gtasks" class="settings-button">Authorize Google Tasks</button>
                </div>
            </div>
            
            <div class="settings-option">
                <label class="settings-label">Refresh interval (minutes):</label>
                <input type="number" id="shopping-refresh" class="settings-input" min="1" max="60" value="5">
            </div>
            <div class="settings-option">
                <label class="settings-label">
                    <input type="checkbox" id="shopping-show-add" class="settings-checkbox" checked>
                    Show add item control on dashboard
                </label>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Display</div>
            <div class="settings-option">
                <label class="settings-label">Dark mode hours:</label>
                <div class="settings-time-range">
                    <label>Start: </label>
                    <input type="time" id="dark-mode-start" class="settings-input" value="19:00">
                    <label>End: </label>
                    <input type="time" id="dark-mode-end" class="settings-input" value="07:00">
                </div>
            </div>
            <div class="settings-option">
                <label class="settings-label">Kiosk mode (hide settings toggle):</label>
                <input type="checkbox" id="kiosk-mode" class="settings-checkbox">
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Widgets</div>
            <div class="settings-option">
                <div class="widget-control">
                    <label>Weather</label>
                    <input type="checkbox" id="widget-weather" class="settings-checkbox" checked>
                </div>
                <div class="widget-control">
                    <label>Calendar</label>
                    <input type="checkbox" id="widget-calendar" class="settings-checkbox" checked>
                </div>
                <div class="widget-control">
                    <label>Shopping List</label>
                    <input type="checkbox" id="widget-shopping" class="settings-checkbox" checked>
                </div>
                <div class="widget-control">
                    <label>Hourly Forecast</label>
                    <input type="checkbox" id="widget-hourly" class="settings-checkbox" checked>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-option">
                <button id="save-settings" class="settings-button">Save Settings</button>
                <button id="reset-settings" class="settings-button danger">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <div class="top-row">
        <div class="time-date">
            <div class="time-display">8:12<sup>51</sup></div>
            <div class="date-display">Friday Feb 28</div>
        </div>
        <div class="weather-now">
            <div class="temp-display">41° <i class="fas fa-sun"></i></div>
            <div class="feels-like">Feels like 34</div>
        </div>
    </div>

    <div class="current-day">
        <div class="big-day">28</div>
        <div class="today-label">Today</div>
        <div class="today-weather">
            <i class="fas fa-cloud-sun"></i> 40° / 56°
        </div>
    </div>

    <div class="middle-section">
        <div class="today-events">
            <div class="event">
                <span class="event-time">10:30 AM</span>
                <span class="event-title cal-0">Dentist mom</span>
            </div>
            <div class="event">
                <span class="event-time">1:00 PM</span>
                <span class="event-title cal-1">Kitchen design</span>
            </div>
        </div>

        <div class="forecast-days">
            <div class="day-forecast">
                <div class="day-header">
                    <div>
                        <div class="day-date">01</div>
                        <div class="day-name">March, Saturday</div>
                    </div>
                    <div class="day-temp">
                        <i class="fas fa-cloud"></i> 58°
                    </div>
                </div>
                <div class="day-events">
                    <div class="day-event">
                        <span class="event-time">12:30 PM</span>
                        <span class="event-title cal-2">Michelle for lunch</span>
                    </div>
                    <div class="day-event">
                        <span class="event-time">1:30 PM</span>
                        <span class="event-title cal-0">Golf lesson</span>
                    </div>
                </div>
            </div>

            <div class="day-forecast">
                <div class="day-header">
                    <div>
                        <div class="day-date">02</div>
                        <div class="day-name">March, Sunday</div>
                    </div>
                    <div class="day-temp">
                        <i class="fas fa-cloud-sun"></i> 40°
                    </div>
                </div>
                <div class="day-events">
                    <div class="day-event">
                        <span class="event-time">3:00 PM</span>
                        <span class="event-title cal-1">TPEG</span>
                    </div>
                </div>
            </div>

            <div class="day-forecast">
                <div class="day-header">
                    <div>
                        <div class="day-date">03</div>
                        <div class="day-name">March, Monday</div>
                    </div>
                    <div class="day-temp">
                        <i class="fas fa-cloud-sun"></i> 43°
                    </div>
                </div>
                <div class="day-events">
                    <div class="day-event">
                        <span>No events</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="shopping-list">
            <div class="shopping-title">Shopping</div>
            <div id="shopping-items"></div>
            <div class="shopping-new-item">
                <input type="text" id="shopping-add-input" placeholder="Add item">
                <button id="shopping-add-btn" class="settings-button">Add</button>
            </div>
        </div>
    </div>

    <div class="hourly-forecast">
        <div class="hour-forecast">
            <div class="hour-label">9am</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">45°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">10am</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">47°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">11am</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">48°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">12pm</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">50°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">1pm</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">51°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">2pm</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">52°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">3pm</div>
            <div class="hour-icon"><i class="fas fa-cloud-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">53°</div>
        </div>
        <div class="hour-forecast">
            <div class="hour-label">4pm</div>
            <div class="hour-icon"><i class="fas fa-sun"></i></div>
            <div class="hour-precipitation">0%</div>
            <div class="hour-temp">54°</div>
        </div>
    </div>

    <script>
/* ------------------- Existing Code -------------------- */

// Settings management
let settings = {
    location: {
        useBrowser: true,
        city: "Arlington",
        state: "VA",
        zip: "22201",
        country: "USA",
        lat: null,
        lon: null
    },
    weather: {
        apiKey: "",
        units: "imperial",
        refreshInterval: 15
    },
    calendar: {
        calendars: [],
        refreshInterval: 5
    },
    shopping: {
        service: "todoist",
        todoistToken: "",
        todoistProject: "Shopping",
        gTasksList: "Shopping",
        refreshInterval: 5,
        showAddControls: true
    },
    display: {
        darkModeStart: "19:00",
        darkModeEnd: "07:00",
        kioskMode: false
    },
    widgets: {
        weather: true,
        calendar: true,
        shopping: true,
        hourly: true
    }
};

// Load settings from localStorage if available
function loadSettings() {
    const savedSettings = localStorage.getItem('dashboardSettings');
    if (savedSettings) {
        try {
            settings = JSON.parse(savedSettings);
            
            // Apply settings to form fields
            document.getElementById('use-browser-location').checked = settings.location.useBrowser;
            document.getElementById('location-city').value = settings.location.city || 'Arlington';
            document.getElementById('location-state').value = settings.location.state || 'VA';
            document.getElementById('location-zip').value = settings.location.zip || '22201';
            document.getElementById('location-country').value = settings.location.country || 'USA';
            
            document.getElementById('weather-api-key').value = settings.weather.apiKey || '';
            document.getElementById('weather-units').value = settings.weather.units || 'imperial';
            document.getElementById('weather-refresh').value = settings.weather.refreshInterval || 15;
            
            document.getElementById('calendar-refresh').value = settings.calendar.refreshInterval || 5;
            
            // Load calendars
            if (settings.calendar.calendars && settings.calendar.calendars.length > 0) {
                // Clear existing calendar inputs
                document.getElementById('calendars-container').innerHTML = '';
                
                // Add saved calendars
                settings.calendar.calendars.forEach(cal => {
                    addCalendarInput(cal.name, cal.url, cal.color, cal.enabled);
                });
            } else {
                // Add an empty calendar input if none exist
                addCalendarInput();
            }
            
            document.getElementById('shopping-service').value = settings.shopping.service || 'google';
            document.getElementById('todoist-api-token').value = settings.shopping.todoistToken || '';
            document.getElementById('todoist-project').value = settings.shopping.todoistProject || 'Shopping';
            document.getElementById('gtasks-list').value = settings.shopping.gTasksList || 'Shopping';
            document.getElementById('shopping-refresh').value = settings.shopping.refreshInterval || 5;
            document.getElementById('shopping-show-add').checked = settings.shopping.showAddControls !== false;
            
            document.getElementById('dark-mode-start').value = settings.display.darkModeStart || '19:00';
            document.getElementById('dark-mode-end').value = settings.display.darkModeEnd || '07:00';
            document.getElementById('kiosk-mode').checked = settings.display.kioskMode || false;
            
            document.getElementById('widget-weather').checked = settings.widgets.weather !== false;
            document.getElementById('widget-calendar').checked = settings.widgets.calendar !== false;
            document.getElementById('widget-shopping').checked = settings.widgets.shopping !== false;
            document.getElementById('widget-hourly').checked = settings.widgets.hourly !== false;
            
            // Toggle manual location inputs
            document.getElementById('manual-location-input').style.display = 
                settings.location.useBrowser ? 'none' : 'block';
            
            // Toggle shopping service settings
            document.getElementById('todoist-settings').style.display = 
                settings.shopping.service === 'todoist' ? 'block' : 'none';
            document.getElementById('google-tasks-settings').style.display =
                settings.shopping.service === 'google' ? 'block' : 'none';

            updateAddItemVisibility();
            
            // Apply kiosk mode if enabled
            if (settings.display.kioskMode) {
                document.body.classList.add('kiosk-mode');
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            // If there's an error loading settings, we'll use the defaults
            addCalendarInput(); // Add at least one empty calendar input
        }
    } else {
        // No saved settings, add an empty calendar input
        addCalendarInput();
    }
}

// Save settings to localStorage
function saveSettings() {
    try {
        // Collect data from form fields
        settings.location.useBrowser = document.getElementById('use-browser-location').checked;
        settings.location.city = document.getElementById('location-city').value;
        settings.location.state = document.getElementById('location-state').value;
        settings.location.zip = document.getElementById('location-zip').value;
        settings.location.country = document.getElementById('location-country').value;
        
        settings.weather.apiKey = document.getElementById('weather-api-key').value;
        settings.weather.units = document.getElementById('weather-units').value;
        settings.weather.refreshInterval = parseInt(document.getElementById('weather-refresh').value) || 15;
        
        // Collect calendar data
        settings.calendar.calendars = collectCalendarData();
        settings.calendar.refreshInterval = parseInt(document.getElementById('calendar-refresh').value) || 5;
        
        settings.shopping.service = document.getElementById('shopping-service').value;
        settings.shopping.todoistToken = document.getElementById('todoist-api-token').value;
        settings.shopping.todoistProject = document.getElementById('todoist-project').value;
        settings.shopping.gTasksList = document.getElementById('gtasks-list').value;
        settings.shopping.refreshInterval = parseInt(document.getElementById('shopping-refresh').value) || 5;
        settings.shopping.showAddControls = document.getElementById('shopping-show-add').checked;
        
        settings.display.darkModeStart = document.getElementById('dark-mode-start').value;
        settings.display.darkModeEnd = document.getElementById('dark-mode-end').value;
        settings.display.kioskMode = document.getElementById('kiosk-mode').checked;
        
        settings.widgets.weather = document.getElementById('widget-weather').checked;
        settings.widgets.calendar = document.getElementById('widget-calendar').checked;
        settings.widgets.shopping = document.getElementById('widget-shopping').checked;
        settings.widgets.hourly = document.getElementById('widget-hourly').checked;
        
        // Save to localStorage
        localStorage.setItem('dashboardSettings', JSON.stringify(settings));
        
        // Apply kiosk mode
        if (settings.display.kioskMode) {
            document.body.classList.add('kiosk-mode');
        } else {
            document.body.classList.remove('kiosk-mode');
        }
        
        // Reload data
        initializeDashboard();
        
        // Close settings panel
        document.querySelector('.settings-panel').classList.remove('open');
        
        // Show success message
        alert('Settings saved successfully!');
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings. Please check the console for details.');
    }
}

// Reset settings to defaults
function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to defaults?')) {
        localStorage.removeItem('dashboardSettings');
        location.reload();
    }
}

// Function to add a calendar input to the settings
function addCalendarInput(name = '', url = '', color = '#4285F4', enabled = true) {
    const calendarsList = document.getElementById('calendars-container');
    const index = calendarsList.children.length;
    
    const calendarItem = document.createElement('div');
    calendarItem.className = 'calendar-item';
    
    // Create a well-organized form with clear labels and inputs
    const formContent = `
        <div class="calendar-form-grid">
            <div class="calendar-form-field">
                <label for="cal-name-${index}">Calendar Name:</label>
                <input type="text" id="cal-name-${index}" value="${name}" placeholder="My Calendar">
            </div>
            <div class="calendar-form-field">
                <label for="cal-color-${index}">Color:</label>
                <input type="color" id="cal-color-${index}" value="${color}" class="color-picker">
            </div>
            <div class="calendar-form-field full-width">
                <label for="cal-url-${index}">Calendar URL (ICS/Public):</label>
                <input type="url" id="cal-url-${index}" value="${url}" placeholder="https://calendar.google.com/calendar/ical/...">
            </div>
        </div>
        <div class="calendar-item-footer">
            <div class="calendar-enabled">
                <input type="checkbox" id="cal-enabled-${index}" ${enabled ? 'checked' : ''}>
                <label for="cal-enabled-${index}">Enabled</label>
            </div>
            <button class="settings-button danger remove-calendar-btn">Remove</button>
        </div>
    `;
    
    calendarItem.innerHTML = formContent;
    
    // Add event listener for the remove button
    calendarItem.querySelector('.remove-calendar-btn').addEventListener('click', function() {
        calendarItem.remove();
    });
    
    // Add calendar item to the list
    calendarsList.appendChild(calendarItem);
}

// Function to collect calendar data from the settings form
function collectCalendarData() {
    const calendarsList = document.getElementById('calendars-container');
    const calendarItems = calendarsList.children;
    const calendars = [];
    
    for (let i = 0; i < calendarItems.length; i++) {
        const item = calendarItems[i];
        const nameInput = item.querySelector('input[id^="cal-name-"]');
        const urlInput = item.querySelector('input[id^="cal-url-"]');
        const colorInput = item.querySelector('input[id^="cal-color-"]');
        const enabledInput = item.querySelector('input[id^="cal-enabled-"]');
        
        if (nameInput && urlInput && colorInput && enabledInput) {
            calendars.push({
                name: nameInput.value.trim(),
                url: urlInput.value.trim(),
                color: colorInput.value,
                enabled: enabledInput.checked
            });
        }
    }
    
    return calendars;
}

// Function to parse ICS data
async function parseIcsCalendar(url) {
    try {
        if (!url || url.trim() === '') {
            console.warn('Empty URL provided to parseIcsCalendar');
            return [];
        }
        
        console.log(`Fetching calendar from URL: ${url}`);
        // Use a CORS proxy if needed
        const corsProxy = 'https://corsproxy.io/?'; // Alternative proxy
        const response = await fetch(corsProxy + encodeURIComponent(url));
        
        if (!response.ok) {
            throw new Error(`Failed to fetch calendar: ${response.status}`);
        }
        
        const icsData = await response.text();
        console.log(`Received ICS data of length: ${icsData.length}`);
        
        const events = [];
        
        // Simple regex-based ICS parser
        const eventRegex = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;
        let match;
        
        while ((match = eventRegex.exec(icsData)) !== null) {
            const eventBlock = match[1];
            const event = {};
            
            // Extract summary (title)
            const summaryMatch = /SUMMARY:(.*?)(?:\r\n|\n)/i.exec(eventBlock);
            if (summaryMatch) {
                event.summary = summaryMatch[1].trim();
            }
            
            // Extract start date/time
            const dtStartMatch = /DTSTART(?:;.*?)?:(.*?)(?:\r\n|\n)/i.exec(eventBlock);
            if (dtStartMatch) {
                event.start = parseIcsDate(dtStartMatch[1].trim());
            }
            
            // Extract end date/time
            const dtEndMatch = /DTEND(?:;.*?)?:(.*?)(?:\r\n|\n)/i.exec(eventBlock);
            if (dtEndMatch) {
                event.end = parseIcsDate(dtEndMatch[1].trim());
            }
            
            // Extract location
            const locationMatch = /LOCATION:(.*?)(?:\r\n|\n)/i.exec(eventBlock);
            if (locationMatch) {
                event.location = locationMatch[1].trim();
            }
            
            // Extract description
            const descriptionMatch = /DESCRIPTION:(.*?)(?:\r\n|\n)/i.exec(eventBlock);
            if (descriptionMatch) {
                event.description = descriptionMatch[1].trim();
            }
            
            // Check if this is a future event
            const now = new Date();
            const eventEnd = event.end || event.start;
            
            if (eventEnd && new Date(eventEnd) >= now) {
                events.push(event);
            }
        }
        
        console.log(`Parsed ${events.length} events from calendar`);
        return events;
    } catch (error) {
        console.error('Error parsing ICS calendar:', error);
        return [];
    }
}

// Helper function to parse ICS date strings
function parseIcsDate(icsDate) {
    // Format can be: YYYYMMDD or YYYYMMDDTHHMMSSZ
    if (!icsDate) return null;
    
    let year, month, day, hour = 0, minute = 0, second = 0;
    let isAllDay = false;
    
    if (icsDate.includes('T')) {
        // This is a date with time
        const datePart = icsDate.split('T')[0];
        const timePart = icsDate.split('T')[1].replace('Z', '');
        
        year = parseInt(datePart.substring(0, 4));
        month = parseInt(datePart.substring(4, 6)) - 1; // JS months are 0-based
        day = parseInt(datePart.substring(6, 8));
        
        hour = parseInt(timePart.substring(0, 2));
        minute = parseInt(timePart.substring(2, 4));
        if (timePart.length >= 6) {
            second = parseInt(timePart.substring(4, 6));
        }
    } else {
        // This is a date without time (all-day event)
        year = parseInt(icsDate.substring(0, 4));
        month = parseInt(icsDate.substring(4, 6)) - 1;
        day = parseInt(icsDate.substring(6, 8));
        isAllDay = true;
    }
    
    const date = new Date(Date.UTC(year, month, day, hour, minute, second));
    
    return {
        dateTime: isAllDay ? null : date.toISOString(),
        date: isAllDay ? date.toISOString().split('T')[0] : null
    };
}

// ------------------- Todoist Integration --------------------
let todoistProjectId = null;

async function getTodoistProjectId() {
    if (todoistProjectId) return todoistProjectId;
    const token = settings.shopping.todoistToken;
    const projectName = settings.shopping.todoistProject || 'Shopping';
    if (!token) return null;
    try {
        const resp = await fetch('https://api.todoist.com/rest/v2/projects', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) {
            console.error('Failed to fetch Todoist projects:', resp.status);
            return null;
        }
        const projects = await resp.json();
        const proj = projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
        if (proj) {
            todoistProjectId = proj.id;
        } else {
            console.warn('Todoist project not found:', projectName);
        }
        return todoistProjectId;
    } catch (err) {
        console.error('Error fetching Todoist projects:', err);
        return null;
    }
}

async function loadShoppingList() {
    if (settings.shopping.service !== 'todoist') return;
    const token = settings.shopping.todoistToken;
    const projectId = await getTodoistProjectId();
    if (!token || !projectId) return;
    try {
        const resp = await fetch(`https://api.todoist.com/rest/v2/tasks?project_id=${projectId}`,
            { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) {
            console.error('Failed to fetch Todoist tasks:', resp.status);
            return;
        }
        const items = await resp.json();
        renderShoppingList(items);
    } catch (err) {
        console.error('Error loading Todoist tasks:', err);
    }
}

function renderShoppingList(items) {
    const container = document.getElementById('shopping-items');
    if (!container) return;
    container.innerHTML = '';
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shopping-item';

        const span = document.createElement('span');
        span.className = 'shopping-text';
        span.textContent = item.content;
        div.appendChild(span);
        container.appendChild(div);
    });
    updateAddItemVisibility();
}

async function addShoppingItem() {
    if (settings.shopping.service !== 'todoist') return;
    const token = settings.shopping.todoistToken;
    const projectId = await getTodoistProjectId();
    const input = document.getElementById('shopping-add-input');
    const title = input.value.trim();
    if (!token || !projectId || !title) return;
    try {
        await fetch('https://api.todoist.com/rest/v2/tasks', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: title, project_id: projectId })
        });
        input.value = '';
        loadShoppingList();
    } catch (err) {
        console.error('Error adding Todoist task:', err);
    }
}

function updateAddItemVisibility() {
    const container = document.querySelector('.shopping-new-item');
    if (container) {
        container.style.display = settings.shopping.showAddControls ? 'flex' : 'none';
    }
}

// Load calendar events
async function loadCalendarEvents() {
    try {
        const enabledCalendars = settings.calendar.calendars.filter(cal => cal.enabled && cal.url);
        if (enabledCalendars.length === 0) {
            console.log("No enabled calendars found");
            return;
        }
        
        const now = new Date();
        const allEvents = [];
        
        for (const calendar of enabledCalendars) {
            if (!calendar.url) continue;
            
            console.log(`Fetching calendar: ${calendar.name} (${calendar.url})`);
            try {
                const events = await parseIcsCalendar(calendar.url);
                console.log(`Found ${events.length} events for calendar ${calendar.name}`);
                
                events.forEach(event => {
                    // Add calendar info to event
                    event.calendarName = calendar.name;
                    event.backgroundColor = calendar.color;
                    allEvents.push(event);
                });
            } catch (calError) {
                console.error(`Error loading calendar ${calendar.name}:`, calError);
            }
        }
        
        // Sort all events by start time
        allEvents.sort((a, b) => {
            const aStart = a.start.dateTime ? new Date(a.start.dateTime) : new Date(a.start.date);
            const bStart = b.start.dateTime ? new Date(b.start.dateTime) : new Date(b.start.date);
            return aStart - bStart;
        });
        
        // Group events by day
        const eventsByDay = {};
        
        for (let i = 0; i < 4; i++) { // Today + 3 days
            const date = new Date();
            date.setDate(now.getDate() + i);
            const dateKey = date.toISOString().split('T')[0];
            eventsByDay[dateKey] = [];
        }
        
        allEvents.forEach(event => {
            const start = event.start.dateTime ? new Date(event.start.dateTime) : new Date(event.start.date);
            const dateKey = start.toISOString().split('T')[0];
            
            if (eventsByDay[dateKey]) {
                eventsByDay[dateKey].push(event);
            }
        });
        
        // Update today's events
        const todayKey = now.toISOString().split('T')[0];
        const todayEvents = eventsByDay[todayKey] || [];
        const todayEventsElement = document.querySelector('.today-events');
        
        if (todayEvents.length === 0) {
            todayEventsElement.innerHTML = '<div class="event"><span>No events today</span></div>';
        } else {
            todayEventsElement.innerHTML = '';
            todayEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'event';
                
                const timeElement = document.createElement('span');
                timeElement.className = 'event-time';
                
                if (event.start.dateTime) {
                    const startTime = new Date(event.start.dateTime);
                    const hours = startTime.getHours();
                    const minutes = startTime.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const hours12 = hours % 12 || 12;
                    timeElement.textContent = `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                } else {
                    timeElement.textContent = 'All day';
                }
                
                const titleElement = document.createElement('span');
                titleElement.className = 'event-title';
                titleElement.textContent = event.summary;
                
                // Apply calendar color
                titleElement.style.borderLeftColor = event.backgroundColor;
                
                eventElement.appendChild(timeElement);
                eventElement.appendChild(titleElement);
                
                todayEventsElement.appendChild(eventElement);
            });
        }
        
        // Update future days events
        const dateKeys = Object.keys(eventsByDay).sort();
        const forecastElements = document.querySelectorAll('.day-forecast');
        
        for (let i = 0; i < Math.min(dateKeys.length - 1, forecastElements.length); i++) {
            const dateKey = dateKeys[i + 1]; // Skip today
            const dayEvents = eventsByDay[dateKey] || [];
            const dayElement = forecastElements[i];
            
            // Update header date
            const date = new Date(dateKey);
            const dayNum = date.getDate().toString().padStart(2, '0');
            const monthName = date.toLocaleString('default', { month: 'long' });
            const dayName = date.toLocaleString('default', { weekday: 'long' });
            
            dayElement.querySelector('.day-date').textContent = dayNum;
            dayElement.querySelector('.day-name').textContent = `${monthName}, ${dayName}`;
            
            // Update events
            const dayEventsElement = dayElement.querySelector('.day-events');
            
            if (dayEvents.length === 0) {
                dayEventsElement.innerHTML = '<div class="day-event"><span>No events</span></div>';
            } else {
                dayEventsElement.innerHTML = '';
                dayEvents.slice(0, 3).forEach(event => { // Limit to 3 events per day for space
                    const eventElement = document.createElement('div');
                    eventElement.className = 'day-event';
                    
                    const timeElement = document.createElement('span');
                    timeElement.className = 'event-time';
                    
                    if (event.start.dateTime) {
                        const startTime = new Date(event.start.dateTime);
                        const hours = startTime.getHours();
                        const minutes = startTime.getMinutes();
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const hours12 = hours % 12 || 12;
                        timeElement.textContent = `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                    } else {
                        timeElement.textContent = 'All day';
                    }
                    
                    const titleElement = document.createElement('span');
                    titleElement.className = 'event-title';
                    titleElement.textContent = event.summary;
                    
                    // Apply calendar color
                    titleElement.style.borderLeftColor = event.backgroundColor;
                    
                    eventElement.appendChild(timeElement);
                    eventElement.appendChild(titleElement);
                    
                    dayEventsElement.appendChild(eventElement);
                });
                
                // Add indicator if there are more events
                if (dayEvents.length > 3) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'day-event';
                    moreElement.textContent = `+ ${dayEvents.length - 3} more events`;
                    dayEventsElement.appendChild(moreElement);
                }
            }
        }
    } catch (error) {
        console.error('Error loading calendar events:', error);
    }
}

/* ------------------- NEW: Initialization + Hide Spinner -------------------- */

// This function re-runs your data loading logic
async function initializeDashboard() {
    // Load settings from localStorage (applies them to the page)
    loadSettings();
    updateAddItemVisibility();

    // Load calendar events (async)
    await loadCalendarEvents();

    // Load shopping items if using Todoist
    if (settings.shopping.service === 'todoist') {
        loadShoppingList();
        setInterval(loadShoppingList, (settings.shopping.refreshInterval || 5) * 60000);
    }

    // You could also load weather or any other data here if needed
}

// On page load, run the initialization, then hide the spinner
document.addEventListener('DOMContentLoaded', async () => {
    await initializeDashboard();
    // Hide the loading overlay
    document.getElementById('loading-overlay').style.display = 'none';
});

/* ------------------- END -------------------- */

// Add event listeners for settings panel toggles
document.querySelector('.settings-icon').addEventListener('click', () => {
    document.querySelector('.settings-panel').classList.add('open');
});

document.querySelector('.close-settings').addEventListener('click', () => {
    document.querySelector('.settings-panel').classList.remove('open');
});

document.getElementById('add-calendar').addEventListener('click', () => {
    addCalendarInput();
});

document.getElementById('save-settings').addEventListener('click', saveSettings);
document.getElementById('reset-settings').addEventListener('click', resetSettings);

// Shopping list actions
document.getElementById('shopping-add-btn').addEventListener('click', addShoppingItem);
document.getElementById('shopping-add-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') addShoppingItem();
});
document.getElementById('shopping-show-add').addEventListener('change', updateAddItemVisibility);

// Toggle manual location input based on checkbox
document.getElementById('use-browser-location').addEventListener('change', function() {
    document.getElementById('manual-location-input').style.display = this.checked ? 'none' : 'block';
});

// Toggle shopping service settings
document.getElementById('shopping-service').addEventListener('change', function() {
    document.getElementById('todoist-settings').style.display = (this.value === 'todoist') ? 'block' : 'none';
    document.getElementById('google-tasks-settings').style.display = (this.value === 'google') ? 'block' : 'none';
});
document.addEventListener('DOMContentLoaded', () => {
  const timeEl = document.querySelector('.time-display');
  const dateEl = document.querySelector('.date-display');

  function updateClock() {
    const now = new Date();

    // --- time: hh:mm<sup>ss</sup> in 12-hour format (no AM/PM) ---
    let h = now.getHours() % 12 || 12;              // convert 0→12
    let m = now.getMinutes().toString().padStart(2,'0');
    let s = now.getSeconds().toString().padStart(2,'0');
    timeEl.innerHTML = `${h}:${m}<sup>${s}</sup>`;

    // --- date: Weekday Mon DD ---
    dateEl.textContent = now.toLocaleDateString('en-US', {
      weekday: 'long',
      month:   'short',
      day:     'numeric'
    });
  }

  updateClock();              // initial write
  setInterval(updateClock, 1000); // update every second
});
    </script>
</body>
</html>
